<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PettyCash Pro - Production Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Professional PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Excel generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg-body: #f8fafc;
            --surface: #ffffff;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-body);
            color: #1e293b;
            -webkit-font-smoothing: antialiased; 
        }

        /* Modern Tabs */
        .tab-btn {
            position: relative;
            color: #64748b;
            transition: all 0.3s ease;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 3px;
            background-color: var(--primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-50%);
            border-radius: 99px;
        }
        .tab-active {
            color: var(--primary);
        }
        .tab-active::after {
            width: 80%;
        }

        /* Glassmorphism & Cards */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .modern-card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            border: 1px solid #f1f5f9;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
        }

        /* Custom Scrollbar */
        .list-scroll-container { max-height: 320px; overflow-y: auto; padding-right: 6px; }
        .list-scroll-container::-webkit-scrollbar { width: 6px; }
        .list-scroll-container::-webkit-scrollbar-track { background: transparent; }
        .list-scroll-container::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 20px; }
        .list-scroll-container::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }

        /* Form Inputs */
        .modern-input {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        .modern-input:focus {
            background-color: #fff;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .transition-smooth { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        
        #status-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 5000;
            min-width: 300px;
            pointer-events: none;
        }

        /* Print Styles */
        #report-printable-area {
            padding: 40px;
            background: white;
            color: black;
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .report-header { border-bottom: 3px solid #4f46e5; padding-bottom: 15px; margin-bottom: 30px; text-align: center; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .report-table th, .report-table td { border: 1px solid #e2e8f0; padding: 12px 8px; text-align: left; font-size: 11px; }
        .report-table th { background-color: #f8fafc; color: #475569; font-weight: 800; text-transform: uppercase; }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; margin: 0 !important; }
        }
    </style>
</head>
<body class="pb-20 text-sm">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[2000] bg-slate-50 flex items-center justify-center p-6">
        <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-md space-y-8 border border-slate-100">
            <div class="text-center space-y-3">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-indigo-200">
                    <i data-lucide="shield-check" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">PettyCash<span class="text-indigo-600">Pro</span></h1>
                <p class="text-slate-500 font-medium text-sm" id="auth-title">Authentication Required</p>
            </div>
            
            <div class="space-y-5">
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold uppercase text-slate-500 tracking-wider ml-1">Email Address</label>
                    <input type="email" id="auth-email" placeholder="finance@company.com" class="w-full px-5 py-4 rounded-xl border border-slate-200 focus:border-indigo-600 focus:ring-4 focus:ring-indigo-50 outline-none font-semibold text-slate-800 transition-all bg-slate-50 focus:bg-white">
                </div>
                <div class="space-y-1.5">
                    <label class="text-[11px] font-bold uppercase text-slate-500 tracking-wider ml-1">Password</label>
                    <input type="password" id="auth-password" placeholder="••••••••" class="w-full px-5 py-4 rounded-xl border border-slate-200 focus:border-indigo-600 focus:ring-4 focus:ring-indigo-50 outline-none font-semibold text-slate-800 transition-all bg-slate-50 focus:bg-white">
                </div>
                <button id="auth-primary-btn" onclick="window.handleAuth()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-base hover:bg-indigo-600 hover:shadow-lg hover:shadow-indigo-200 transition-all transform active:scale-[0.98]">Sign In</button>
                
                <div class="flex flex-col gap-4 pt-2">
                    <div class="flex items-center gap-3">
                        <div class="flex-1 h-px bg-slate-200"></div>
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Options</span>
                        <div class="flex-1 h-px bg-slate-200"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.toggleAuthMode()" id="auth-toggle-btn" class="px-4 py-3 rounded-xl font-bold text-xs bg-slate-50 text-slate-600 hover:bg-slate-100 transition-colors">Create Account</button>
                        <button onclick="window.handleGuestLogin()" class="px-4 py-3 rounded-xl font-bold text-xs bg-white border border-slate-200 text-slate-600 hover:border-indigo-200 hover:text-indigo-600 transition-colors">Guest Mode</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Content -->
    <div id="app-content" class="hidden min-h-screen flex flex-col">
        <!-- Modern Navbar -->
        <nav class="glass-panel sticky top-0 z-50 border-b border-slate-200/60 no-print">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-indigo-600 p-2.5 rounded-xl shadow-lg shadow-indigo-200"><i data-lucide="shield-check" class="text-white w-5 h-5"></i></div>
                        <div>
                            <h1 class="font-extrabold text-xl tracking-tight text-slate-900">PettyCash<span class="text-indigo-600">Pro</span></h1>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none mt-0.5">Enterprise Finance</p>
                        </div>
                    </div>
                    <div class="flex gap-1 bg-slate-100/50 p-1.5 rounded-2xl border border-slate-200/60">
                        <button onclick="window.switchView('dashboard')" id="nav-dashboard" class="flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all font-bold text-xs shadow-sm bg-white text-indigo-600"><i data-lucide="layout-dashboard" class="w-4 h-4"></i> <span class="hidden sm:inline">Overview</span></button>
                        <button onclick="window.switchView('history')" id="nav-history" class="flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all text-slate-500 hover:text-slate-700 hover:bg-white/60 font-bold text-xs"><i data-lucide="file-bar-chart-2" class="w-4 h-4"></i> <span class="hidden sm:inline">Reports</span></button>
                        <button onclick="window.switchView('settings')" id="nav-settings" class="flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all text-slate-500 hover:text-slate-700 hover:bg-white/60 font-bold text-xs"><i data-lucide="settings-2" class="w-4 h-4"></i> <span class="hidden sm:inline">Config</span></button>
                    </div>
                    <button onclick="window.handleLogout()" class="p-2.5 text-rose-500 hover:bg-rose-50 rounded-xl transition-colors border border-transparent hover:border-rose-100 ml-2" title="Sign Out"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </div>
        </nav>

        <main class="flex-grow max-w-7xl mx-auto w-full p-6 lg:p-8 no-print space-y-8">
            
            <!-- Global Status Alerts (Toast) -->
            <div id="status-container" class="hidden bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 animate-in slide-in-from-bottom-5 duration-300">
                <div id="status-icon" class="text-emerald-400"></div>
                <div>
                    <p id="status-text" class="font-bold text-sm"></p>
                </div>
            </div>

            <!-- View: Dashboard -->
            <div id="view-dashboard" class="space-y-8 animate-in fade-in duration-500">
                
                <!-- Financial Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="modern-card p-6 border-l-4 border-l-indigo-500">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-indigo-50 rounded-xl text-indigo-600"><i data-lucide="wallet" class="w-6 h-6"></i></div>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest bg-slate-50 px-2 py-1 rounded-lg">Available</span>
                        </div>
                        <p class="text-sm font-bold text-slate-500 mb-1">Cash On Hand</p>
                        <h3 id="stat-balance" class="text-3xl font-extrabold text-slate-800 tracking-tight">0.00 <span class="text-base text-slate-400">AED</span></h3>
                    </div>

                    <div class="modern-card p-6 border-l-4 border-l-amber-500">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-amber-50 rounded-xl text-amber-600"><i data-lucide="forward" class="w-6 h-6"></i></div>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest bg-slate-50 px-2 py-1 rounded-lg">Receivables</span>
                        </div>
                        <p class="text-sm font-bold text-slate-500 mb-1">Active Advances</p>
                        <h3 id="stat-advances" class="text-3xl font-extrabold text-slate-800 tracking-tight">0.00 <span class="text-base text-slate-400">AED</span></h3>
                    </div>

                    <div class="modern-card p-6 border-l-4 border-l-rose-500">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-3 bg-rose-50 rounded-xl text-rose-600"><i data-lucide="alert-circle" class="w-6 h-6"></i></div>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest bg-slate-50 px-2 py-1 rounded-lg">Payables</span>
                        </div>
                        <p class="text-sm font-bold text-slate-500 mb-1">Total Debts</p>
                        <h3 id="stat-payables" class="text-3xl font-extrabold text-slate-800 tracking-tight">0.00 <span class="text-base text-slate-400">AED</span></h3>
                    </div>
                </div>

                <!-- Main Action & Tracking Area -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    
                    <!-- Left: Entry Form -->
                    <div class="xl:col-span-2 modern-card overflow-hidden flex flex-col">
                        <div class="bg-slate-50/50 border-b border-slate-100 p-2 flex overflow-x-auto no-scrollbar" id="tab-container">
                            <button onclick="window.setActiveTab('expense')" data-tab="expense" class="tab-btn tab-active flex-1 py-3 px-6 text-xs font-bold uppercase tracking-wide flex items-center justify-center gap-2"><i data-lucide="receipt"></i> Expense</button>
                            <button onclick="window.setActiveTab('advance')" data-tab="advance" class="tab-btn flex-1 py-3 px-6 text-xs font-bold uppercase tracking-wide flex items-center justify-center gap-2"><i data-lucide="send"></i> Give Advance</button>
                            <button onclick="window.setActiveTab('receive')" data-tab="receive" class="tab-btn flex-1 py-3 px-6 text-xs font-bold uppercase tracking-wide flex items-center justify-center gap-2"><i data-lucide="plus-circle"></i> Add Funds</button>
                        </div>

                        <form id="entry-form" onsubmit="window.handleInitialSubmit(event)" class="p-8 space-y-6 flex-grow">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="space-y-2">
                                    <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide ml-1">Amount (AED)</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                                        <input type="number" id="form-amount" step="0.01" required placeholder="0.00" oninput="window.checkAdvanceWallet(document.getElementById('form-person').value)" class="modern-input w-full pl-8 pr-4 py-4 rounded-xl text-xl font-bold text-slate-800">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex justify-between items-center ml-1">
                                        <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide">Beneficiary</label>
                                        <button type="button" onclick="window.sendDailySummary()" class="text-[10px] font-bold text-emerald-600 hover:text-emerald-700 flex items-center gap-1 uppercase tracking-wide transition-colors" title="Send today's transaction summary via WhatsApp"><i data-lucide="message-circle" class="w-3 h-3"></i> Daily Summary</button>
                                    </div>
                                    <div id="person-select-wrapper">
                                        <!-- Injected via JS -->
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide ml-1">Transaction Date</label>
                                    <input type="date" id="form-sub-date" required class="modern-input w-full px-4 py-4 rounded-xl font-bold text-sm text-slate-800">
                                </div>
                            </div>

                            <div id="allocation-section" class="hidden space-y-4 pt-4 border-t border-slate-100">
                                <div class="flex items-center justify-between">
                                    <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide flex items-center gap-2"><i data-lucide="pie-chart" class="w-4 h-4"></i> Cost Allocation</label>
                                    <button type="button" onclick="window.addAllocationRow()" class="text-indigo-600 text-[10px] font-bold uppercase hover:underline hover:text-indigo-700 transition-colors">+ Add Split</button>
                                </div>
                                <div id="allocation-rows-container" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <!-- Dynamic Rows -->
                                </div>
                            </div>

                            <!-- Advance Deduction & Reimburse Options -->
                            <div id="advance-deduction-container" class="hidden space-y-3">
                                <label class="flex items-center gap-4 p-4 bg-amber-50/50 rounded-xl border border-amber-100 cursor-pointer hover:bg-amber-50 transition-colors">
                                    <input type="checkbox" id="use-advance-wallet" class="w-5 h-5 rounded border-amber-300 text-amber-600 focus:ring-amber-500" onchange="window.toggleReimburseOption()">
                                    <div>
                                        <p id="advance-deduction-text" class="text-xs font-bold text-amber-900 uppercase tracking-wide"></p>
                                        <p id="advance-balance-text" class="text-[10px] text-amber-600 font-bold mt-0.5"></p>
                                    </div>
                                </label>
                                
                                <!-- Pay Remainder Toggle (Hidden by default) -->
                                <div id="reimburse-option-container" class="hidden">
                                    <label class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors">
                                        <input type="checkbox" id="reimburse-now" class="w-5 h-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                        <div>
                                            <p class="text-xs font-bold text-slate-800 uppercase tracking-wide">Reimburse Excess Immediately?</p>
                                            <p class="text-[10px] text-slate-500 font-bold mt-0.5">Uncheck to record as pending debt (Pay later)</p>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <div id="reimburse-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                                <div class="space-y-2">
                                    <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide ml-1">Invoice Number</label>
                                    <input type="text" id="form-inv-no" placeholder="INV-000" class="modern-input w-full px-4 py-3 rounded-xl font-bold text-sm text-slate-800">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide ml-1">Invoice Date</label>
                                    <input type="date" id="form-inv-date" class="modern-input w-full px-4 py-3 rounded-xl font-bold text-sm text-slate-800">
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide ml-1">Description / Memo</label>
                                <input type="text" id="form-desc" required placeholder="What is this transaction for?" class="modern-input w-full px-4 py-3 rounded-xl font-medium text-sm text-slate-800">
                            </div>

                            <button type="submit" id="process-btn" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-base hover:bg-indigo-600 hover:shadow-lg hover:shadow-indigo-200 transition-all transform active:scale-[0.99] flex items-center justify-center gap-2">
                                <i data-lucide="check-circle" class="w-5 h-5"></i> Confirm Transaction
                            </button>
                        </form>
                    </div>

                    <!-- Right: Tracking Lists -->
                    <div class="space-y-6">
                        <!-- Active Advances -->
                        <div id="advances-section" class="modern-card p-6 hidden">
                            <div class="flex items-center gap-2 mb-4 border-b border-slate-100 pb-3">
                                <div class="p-1.5 bg-amber-100 rounded-lg text-amber-600"><i data-lucide="wallet" class="w-4 h-4"></i></div>
                                <h2 class="text-xs font-black text-slate-800 uppercase tracking-widest">Staff Advances</h2>
                            </div>
                            <div id="advances-list" class="space-y-3 list-scroll-container">
                                <!-- Populated via JS -->
                            </div>
                        </div>

                        <!-- Repayments Needed -->
                        <div id="pending-debts-section" class="modern-card p-6 hidden">
                            <div class="flex items-center gap-2 mb-4 border-b border-slate-100 pb-3">
                                <div class="p-1.5 bg-rose-100 rounded-lg text-rose-600"><i data-lucide="alert-octagon" class="w-4 h-4"></i></div>
                                <h2 class="text-xs font-black text-slate-800 uppercase tracking-widest">Pending Repayments</h2>
                            </div>
                            <div id="debts-container" class="space-y-3 list-scroll-container">
                                <!-- Populated via JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: History (Reports) -->
            <div id="view-history" class="space-y-6 hidden animate-in fade-in duration-500">
                <div class="bg-indigo-900 text-white p-8 rounded-[2rem] shadow-xl overflow-hidden relative border border-indigo-800">
                    <div class="absolute top-0 right-0 p-8 opacity-10"><i data-lucide="file-bar-chart-2" class="w-64 h-64"></i></div>
                    <div class="relative z-10">
                        <h2 class="text-2xl font-extrabold mb-6 tracking-tight text-white">Reporting Engine</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="space-y-1.5">
                                <label class="text-[10px] font-bold uppercase text-indigo-300 tracking-wider">Category</label>
                                <select id="filter-cat" class="w-full bg-indigo-800/50 border border-indigo-700/50 rounded-xl text-xs p-3 font-bold outline-none text-white focus:ring-2 focus:ring-indigo-400 transition-all"><option value="all">All Categories</option></select>
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[10px] font-bold uppercase text-indigo-300 tracking-wider">Property #</label>
                                <input type="text" id="filter-prop" placeholder="Any" class="w-full bg-indigo-800/50 border border-indigo-700/50 rounded-xl text-xs p-3 font-bold outline-none text-white focus:ring-2 focus:ring-indigo-400 placeholder-indigo-400/50 transition-all">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[10px] font-bold uppercase text-indigo-300 tracking-wider">Start Date</label>
                                <input type="date" id="filter-start" class="w-full bg-indigo-800/50 border border-indigo-700/50 rounded-xl text-xs p-3 font-bold outline-none text-white focus:ring-2 focus:ring-indigo-400 transition-all">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[10px] font-bold uppercase text-indigo-300 tracking-wider">End Date</label>
                                <input type="date" id="filter-end" class="w-full bg-indigo-800/50 border border-indigo-700/50 rounded-xl text-xs p-3 font-bold outline-none text-white focus:ring-2 focus:ring-indigo-400 transition-all">
                            </div>
                        </div>
                        <div class="mt-8 flex flex-col md:flex-row gap-4">
                            <button onclick="window.renderAll()" class="flex-1 bg-white text-indigo-900 py-3.5 rounded-xl font-black text-xs hover:bg-indigo-50 transition-all shadow-lg flex justify-center items-center gap-2"><i data-lucide="filter"></i> Apply Filters</button>
                            <button onclick="window.generateReportPDF()" class="flex-1 bg-indigo-600 text-white py-3.5 rounded-xl font-black text-xs hover:bg-indigo-500 border border-indigo-500 transition-all shadow-lg flex justify-center items-center gap-2"><i data-lucide="download"></i> Export PDF</button>
                            <button onclick="window.generateReportExcel()" class="flex-1 bg-emerald-600 text-white py-3.5 rounded-xl font-black text-xs hover:bg-emerald-500 border border-emerald-500 transition-all shadow-lg flex justify-center items-center gap-2"><i data-lucide="file-spreadsheet"></i> Export Excel</button>
                        </div>
                    </div>
                </div>

                <div class="modern-card overflow-hidden">
                    <div class="p-6 border-b border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-sm font-black text-slate-700 uppercase tracking-widest flex items-center gap-2"><i data-lucide="list"></i> Transaction History</h2>
                            <div id="log-count-container" class="text-[10px] font-bold bg-white border border-slate-200 px-3 py-1.5 rounded-full text-slate-500 shadow-sm"><span id="log-count">0</span> entries</div>
                        </div>
                        <div class="relative">
                            <input type="text" id="filter-general" oninput="window.renderAll()" placeholder="Search transactions (Date, Person, Memo...)" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/10 transition-all">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                <i data-lucide="search" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/80 text-[10px] font-extrabold text-slate-400 uppercase tracking-widest border-b border-slate-100">
                                    <th class="px-6 py-4">Date</th>
                                    <th class="px-6 py-4">Person</th>
                                    <th class="px-6 py-4">Details</th>
                                    <th class="px-6 py-4">Amount</th>
                                    <th class="px-6 py-4">Balance</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="audit-body" class="divide-y divide-slate-100 text-xs"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- View: Setup -->
            <div id="view-settings" class="hidden space-y-8 animate-in fade-in duration-500">
                <div class="modern-card p-8 flex flex-col md:flex-row items-center justify-between gap-6 border-l-4 border-l-indigo-500">
                    <div>
                        <h3 class="text-indigo-900 font-extrabold uppercase tracking-tight text-lg">Data & Backup</h3>
                        <p class="text-slate-500 text-xs mt-1 font-medium">Securely export your financial data or restore from a previous backup file.</p>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="window.exportFullDatabase()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-xs hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all flex items-center gap-2"><i data-lucide="download-cloud"></i> Backup Data</button>
                        <label class="cursor-pointer bg-white text-indigo-600 border border-indigo-200 px-6 py-3 rounded-xl font-bold text-xs hover:bg-indigo-50 transition-all text-center flex items-center gap-2"><i data-lucide="upload-cloud"></i> Restore Data<input type="file" id="import-db-input" class="hidden" accept=".json" onchange="window.importFullDatabase(event)"></label>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
                    <!-- Staff Config -->
                    <div class="modern-card p-6 h-full flex flex-col">
                        <h3 class="font-black mb-6 flex items-center gap-2 text-slate-800 uppercase text-xs tracking-widest"><i data-lucide="users" class="w-4 h-4 text-indigo-500"></i> Staff Registry</h3>
                        <div class="flex flex-col gap-2 mb-4">
                            <input type="text" id="new-staff" placeholder="Full Name" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none text-xs font-bold focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all">
                            <div class="flex gap-2">
                                <input type="text" id="new-staff-phone" placeholder="Phone (9715...)" class="flex-1 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none text-xs font-bold focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all">
                                <button onclick="window.addItem('staff')" class="bg-indigo-600 text-white px-4 rounded-xl font-bold text-xs hover:bg-indigo-700 transition-all shadow-md">Add</button>
                            </div>
                        </div>
                        <div id="list-staff" class="flex flex-wrap gap-2 content-start flex-grow"></div>
                    </div>

                    <!-- Sources Config -->
                    <div class="modern-card p-6 h-full flex flex-col">
                        <h3 class="font-black mb-6 flex items-center gap-2 text-slate-800 uppercase text-xs tracking-widest"><i data-lucide="building-2" class="w-4 h-4 text-emerald-500"></i> Funding Sources</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-source" placeholder="Source Name" class="flex-1 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none text-xs font-bold focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all">
                            <button onclick="window.addItem('source')" class="bg-emerald-600 text-white px-4 rounded-xl font-bold text-xs hover:bg-emerald-700 transition-all shadow-md">Add</button>
                        </div>
                        <div id="list-source" class="flex flex-wrap gap-2 content-start flex-grow"></div>
                    </div>

                    <!-- Categories Config -->
                    <div class="modern-card p-6 h-full flex flex-col">
                        <h3 class="font-black mb-6 flex items-center gap-2 text-slate-800 uppercase text-xs tracking-widest"><i data-lucide="tag" class="w-4 h-4 text-amber-500"></i> Cost Categories</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-category" placeholder="Category Name" class="flex-1 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none text-xs font-bold focus:ring-2 focus:ring-amber-500/20 focus:border-amber-500 transition-all">
                            <button onclick="window.addItem('category')" class="bg-amber-600 text-white px-4 rounded-xl font-bold text-xs hover:bg-amber-700 transition-all shadow-md">Add</button>
                        </div>
                        <div id="list-category" class="flex flex-wrap gap-2 content-start flex-grow"></div>
                    </div>
                </div>
                
                <div class="pt-8 border-t border-slate-200">
                    <button onclick="window.resetData()" class="w-full bg-rose-50 text-rose-600 py-4 rounded-xl font-black border border-rose-200 uppercase text-xs tracking-widest hover:bg-rose-100 hover:border-rose-300 transition-all flex justify-center items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i> Danger: Factory Reset Database</button>
                </div>
            </div>
        </main>

        <!-- Hidden PDF Template -->
        <div id="report-template" class="hidden">
            <div id="report-printable-area">
                <div class="report-header">
                    <h1 style="font-size: 28px; font-weight: bold; margin-bottom: 5px;">PETTY CASH AUDIT REPORT</h1>
                    <p style="font-size: 14px; color: #444;" id="pdf-report-period"></p>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 12px;">
                    <div>
                        <p style="margin: 3px 0;"><strong>System:</strong> PettyCash Pro v2.0</p>
                        <p style="margin: 3px 0;"><strong>Operator:</strong> <span id="pdf-report-user"></span></p>
                    </div>
                    <div style="text-align: right;">
                        <p style="margin: 3px 0; font-size: 16px;"><strong>Balance:</strong> <span id="pdf-report-balance" style="color: #4f46e5;"></span> <strong>AED</strong></p>
                    </div>
                </div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Person</th>
                            <th>Transaction</th>
                            <th>Description</th>
                            <th>In (+)</th>
                            <th>Out (-)</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body"></tbody>
                </table>
                <div style="margin-top: 50px; border-top: 1px solid #eee; padding-top: 10px; font-size: 10px; text-align: center; color: #999;">
                    Generated on <span id="pdf-generation-time"></span>
                </div>
            </div>
        </div>

        <!-- Receipt Modal -->
        <div id="receipt-modal" class="hidden fixed inset-0 z-[5000] flex items-center justify-center p-4 modal-overlay no-print transition-smooth">
            <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-sm overflow-hidden animate-in zoom-in duration-300 border border-slate-100">
                <div class="p-8 text-center space-y-4">
                    <div class="bg-emerald-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto text-emerald-600 mb-2"><i data-lucide="check" class="w-8 h-8"></i></div>
                    <h3 class="text-xl font-black uppercase tracking-tight text-slate-800">Transaction Recorded</h3>
                    <p class="text-xs text-slate-500 font-bold" id="receipt-message">Notify the beneficiary via WhatsApp?</p>
                    
                    <button id="btn-send-whatsapp-receipt" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold text-sm hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="message-circle" class="w-5 h-5"></i> Send Notification
                    </button>
                    <button onclick="window.closeModal()" class="w-full py-3 text-slate-400 font-bold text-xs hover:text-slate-600 transition-all">Close</button>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="settle-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay no-print transition-smooth">
            <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in duration-300 border border-slate-100">
                <div class="p-8 bg-slate-900 text-white flex justify-between items-center"><div><h3 class="text-xl font-black uppercase tracking-tight" id="settle-title">Settlement</h3><p class="text-[10px] text-slate-400 mt-1 uppercase font-bold tracking-wider" id="settle-subtitle"></p></div><button onclick="window.closeModal()" class="text-slate-400 hover:text-white transition-smooth"><i data-lucide="x"></i></button></div>
                <div class="p-8 space-y-5">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1">Payment Amount (AED)</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                        <input type="number" id="settle-amount-input" step="0.01" class="modern-input w-full pl-8 pr-4 py-4 rounded-xl text-xl font-bold text-slate-800 outline-none focus:border-indigo-600 focus:ring-4 focus:ring-indigo-50">
                    </div>
                </div>
                <div class="p-8 pt-0 flex gap-3 transition-smooth"><button onclick="window.closeModal()" class="flex-1 py-4 font-bold text-slate-500 hover:bg-slate-50 rounded-xl transition-all">Cancel</button><button onclick="window.confirmSettlement()" class="flex-2 bg-indigo-600 text-white px-8 py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all">Confirm Payment</button></div>
            </div>
        </div>

        <div id="edit-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay no-print transition-smooth">
            <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in duration-300 border border-slate-100">
                <div class="p-8 bg-slate-900 text-white flex justify-between items-center"><div><h3 class="text-xl font-black uppercase tracking-tight">Edit Record</h3><p class="text-[10px] text-slate-400 mt-1 uppercase font-bold tracking-wider" id="edit-type-label"></p></div><button onclick="window.closeModal()" class="text-slate-400 hover:text-white transition-smooth"><i data-lucide="x"></i></button></div>
                <div class="p-8 space-y-6 max-h-[60vh] overflow-y-auto no-scrollbar transition-smooth">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Amount (AED)</label>
                            <input type="number" id="edit-amount" step="0.01" class="modern-input w-full px-4 py-3 rounded-xl text-lg font-bold">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Date</label>
                            <input type="date" id="edit-date" class="modern-input w-full px-4 py-3 rounded-xl font-bold text-sm">
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Memo Description</label>
                        <input type="text" id="edit-desc" class="modern-input w-full px-4 py-3 rounded-xl font-medium text-sm">
                    </div>
                </div>
                <div class="p-8 pt-0 flex gap-3 transition-smooth"><button onclick="window.closeModal()" class="flex-1 py-4 font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 rounded-xl transition-all">Cancel</button><button onclick="window.saveEdit()" class="flex-2 bg-indigo-600 text-white px-8 py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all">Save Changes</button></div>
            </div>
        </div>

        <div id="funds-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay no-print">
            <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in duration-300 border border-slate-100">
                <div class="p-8 bg-rose-600 text-white"><h3 class="text-2xl font-black uppercase tracking-tight text-white">Insufficient Funds</h3></div>
                <div class="p-8 space-y-6 text-center">
                    <p id="deficit-value" class="text-3xl font-extrabold text-rose-600 tracking-tight"></p>
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">How would you like to handle the remainder?</p>
                    <div class="grid grid-cols-2 gap-4 transition-smooth">
                        <button onclick="window.processPartial('manager')" class="p-5 rounded-2xl border border-slate-200 bg-slate-50 hover:border-indigo-600 hover:bg-indigo-50 transition-all text-left group">
                            <p class="text-[10px] font-black text-slate-400 uppercase group-hover:text-indigo-600">Option A</p>
                            <p class="text-sm font-bold text-slate-800 mt-1">Personal Payment</p>
                            <p class="text-[10px] text-slate-500 mt-1 leading-tight">I paid the rest from my pocket.</p>
                        </button>
                        <button onclick="window.processPartial('staff')" class="p-5 rounded-2xl border border-slate-200 bg-slate-50 hover:border-rose-600 hover:bg-rose-50 transition-all text-left group">
                            <p class="text-[10px] font-black text-slate-400 uppercase group-hover:text-rose-600">Option B</p>
                            <p class="text-sm font-bold text-slate-800 mt-1">Short Pay Staff</p>
                            <p class="text-[10px] text-slate-500 mt-1 leading-tight">Staff will be owed the difference.</p>
                        </button>
                    </div>
                </div>
                <div class="px-8 pb-8 flex gap-3 transition-smooth"><button onclick="window.closeModal()" class="flex-1 py-4 text-slate-400 font-bold hover:text-slate-600 transition-smooth">Cancel Transaction</button></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Implementation -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBuQEoHzwpZxxSGsa6Qa3SeuxNshK4jMac",
            authDomain: "petty-cash-448b6.firebaseapp.com",
            projectId: "petty-cash-448b6",
            storageBucket: "petty-cash-448b6.firebasestorage.app",
            messagingSenderId: "751484833436",
            appId: "1:751484833436:web:8c3345a43d98fac2de2759"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'petty-cash-pro';

        let txs = [];
        let staff = []; // Array of objects {name: "Name", phone: "123"} or plain strings (legacy)
        let sources = [];
        let categories = ["Warehouses", "Open Yard", "Admin Building", "Site General"];
        let activeTab = 'expense';
        let pendingTxData = null;
        let settlingId = null;
        let settlementType = 'advance';
        let editingTxId = null;
        let currentAllocations = [];
        let isSignupMode = false;
        let currentUser = null;

        // --- GLOBAL UI HELPERS ---

        window.showStatus = function(m, isErr = false) { 
            const c = document.getElementById('status-container'); 
            const icon = document.getElementById('status-icon');
            if(!c) return; 
            
            c.className = isErr 
                ? "fixed bottom-6 right-6 z-[5000] bg-rose-600 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 animate-in slide-in-from-bottom-5 duration-300"
                : "fixed bottom-6 right-6 z-[5000] bg-slate-900 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-4 animate-in slide-in-from-bottom-5 duration-300";
            
            document.getElementById('status-text').innerText = m; 
            icon.innerHTML = isErr ? '<i data-lucide="alert-triangle" class="w-6 h-6"></i>' : '<i data-lucide="check-circle-2" class="w-6 h-6 text-emerald-400"></i>';
            c.classList.remove('hidden'); 
            lucide.createIcons();
            setTimeout(() => { if(c) c.classList.add('hidden'); }, 1000); 
        };

        // Moved to TOP for global availability
        window.checkAdvanceWallet = function(person) {
            const container = document.getElementById('advance-deduction-container'); 
            if(!container) return;
            if (activeTab !== 'expense') { container.classList.add('hidden'); return; }
            const wallet = getAdvanceWalletFor(person);
            if (wallet > 0.01) {
                container.classList.remove('hidden');
                const tEl = document.getElementById('advance-deduction-text');
                const bEl = document.getElementById('advance-balance-text');
                if(tEl) tEl.innerText = `Deduct from ${person}'s Advance`;
                if(bEl) bEl.innerText = `Available: ${wallet.toFixed(2)} AED`;
                
                // Show/Hide Reimburse option
                const amount = parseFloat(document.getElementById('form-amount')?.value) || 0;
                const reimContainer = document.getElementById('reimburse-option-container');
                const useAdv = document.getElementById('use-advance-wallet')?.checked;
                
                if (useAdv && amount > wallet && reimContainer) {
                    reimContainer.classList.remove('hidden');
                } else if (reimContainer) {
                    reimContainer.classList.add('hidden');
                }

            } else { container.classList.add('hidden'); }
        };
        
        window.toggleReimburseOption = function() {
             const person = document.getElementById('form-person').value;
             window.checkAdvanceWallet(person);
        }

        window.closeModal = function() { 
            ['funds-modal', 'settle-modal', 'edit-modal', 'receipt-modal'].forEach(id => { 
                const el = document.getElementById(id); if(el) el.classList.add('hidden'); 
            }); 
        };

        window.getTypeStyles = function(type) { 
            const s = { 
                receive: 'bg-emerald-100 text-emerald-700 border border-emerald-200', 
                expense: 'bg-slate-100 text-slate-700 border border-slate-200', 
                advance: 'bg-amber-100 text-amber-700 border border-amber-200', 
                repayment: 'bg-rose-100 text-rose-700 border border-rose-200' 
            }; 
            return s[type] || 'bg-slate-50 text-slate-500'; 
        };

        // --- DATA HELPERS ---
        // SAFE GUARDS against null/undefined data from Firestore
        const getStaffName = (s) => (s && typeof s === 'object') ? s.name : (s || '');
        const getStaffPhone = (s) => (s && typeof s === 'object') ? s.phone : '';
        const escapeQuotes = (str) => str ? str.replace(/'/g, "\\'") : '';
        // NEW: Helper to clean phone numbers (removes spaces, +, dashes)
        const cleanPhone = (p) => p ? p.toString().replace(/\D/g, '') : '';

        // --- ACCOUNTING ENGINE ---

        function getAdvanceWalletFor(person) {
            let given = 0, used = 0, refunded = 0;
            txs.forEach(t => {
                if (t.person === person) {
                    if (t.type === 'advance') given += (parseFloat(t.amount) || 0);
                    if (t.isDeductedFromAdvance) used += (parseFloat(t.advanceAmountUsed) || 0);
                    if (t.type === 'repayment' && t.isAdvanceReturn) refunded += (parseFloat(t.amount) || 0);
                }
            });
            return Math.max(0, given - used - refunded);
        }

        function getTotals() {
            let res = { balance: 0, advances: 0, owedToMe: 0, owedToStaff: 0 };
            txs.forEach(t => {
                const amt = parseFloat(t.amount) || 0;
                const boxPart = parseFloat(t.paidFromBox) || 0;
                if (t.type === 'receive' || (t.type === 'repayment' && t.isAdvanceReturn)) { res.balance += amt; }
                else { res.balance -= boxPart; }
                if (t.managerOwed) res.owedToMe += (parseFloat(t.managerOwed) - (parseFloat(t.repaidAmount) || 0));
                if (t.staffOwed) res.owedToStaff += (parseFloat(t.staffOwed) - (parseFloat(t.repaidAmount) || 0));
            });
            const people = [...new Set(txs.map(t => t.person))];
            people.forEach(p => { if (p && p !== 'Manager') res.advances += getAdvanceWalletFor(p); });
            return res;
        }

        async function savePhoneNumber(name, phone) {
            if (!currentUser) return;
            let staffIndex = staff.findIndex(s => getStaffName(s) === name);
            if (staffIndex !== -1) {
                if (typeof staff[staffIndex] === 'string') {
                    staff[staffIndex] = { name: staff[staffIndex], phone: phone };
                } else {
                    staff[staffIndex].phone = phone;
                }
                await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'config', 'settings'), { staff, sources, categories });
            }
        }

        window.sendWhatsApp = (personName) => {
            const staffObj = staff.find(s => getStaffName(s) === personName);
            let phone = getStaffPhone(staffObj);
            
            if (!phone) {
                phone = prompt(`Enter WhatsApp number for ${personName} (e.g., 971501234567):`);
                if (!phone) return;
                savePhoneNumber(personName, phone); 
            }
            
            // Clean the phone number before sending
            const cleanNumber = cleanPhone(phone);

            const balance = getAdvanceWalletFor(personName);
            const msg = `Hi ${personName}, records show you are currently holding a Petty Cash Advance of ${balance.toFixed(2)} AED. Please submit receipts or settle the cash.`;
            
            const url = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        };

        window.sendDailySummary = () => {
            const personSelect = document.getElementById('form-person');
            if(!personSelect || !personSelect.value) return window.showStatus("Select a person first", true);
            const personName = personSelect.value;
            
            const staffObj = staff.find(s => getStaffName(s) === personName);
            let phone = getStaffPhone(staffObj);
            if (!phone) {
                const isStaff = staff.some(s => getStaffName(s) === personName);
                if (isStaff) {
                    phone = prompt(`Enter WhatsApp number for ${personName} (e.g., 971501234567):`);
                    if (!phone) return;
                    savePhoneNumber(personName, phone); 
                } else {
                    phone = prompt(`Enter number to send summary for ${personName}:`);
                    if (!phone) return;
                }
            }

            // Clean the phone number
            const cleanNumber = cleanPhone(phone);

            const today = new Date().toISOString().split('T')[0];
            const dailyTxs = txs.filter(t => t.person === personName && t.subDate === today);
            
            if(dailyTxs.length === 0) return window.showStatus("No transactions today for " + personName, true);

            let msg = `Hi ${personName}, here is your transaction summary for today (${new Date().toLocaleDateString()}):\n\n`;
            
            dailyTxs.forEach(t => {
                let line = `• ${t.amount.toFixed(2)} AED`;
                
                if (t.type === 'expense') {
                    // Try to use Invoice No if available, otherwise just description
                    const details = t.invoiceNo ? `Inv #${t.invoiceNo} - ${t.desc}` : t.desc;
                    line += ` - ${details}`;
                } else {
                    // For advances/returns, keep the type label to distinguish
                    line += ` (${t.type.toUpperCase()}) - ${t.desc}`;
                }
                msg += `${line}\n`;
            });
            
            const balance = getAdvanceWalletFor(personName);
            msg += `\nCurrent Balance: ${balance.toFixed(2)} AED`;

            const url = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        };

        window.openReceiptModal = (type, amount, person, desc) => {
            if (type !== 'advance' && type !== 'repayment') return; 
            
            const modal = document.getElementById('receipt-modal');
            const btn = document.getElementById('btn-send-whatsapp-receipt');
            
            modal.classList.remove('hidden');
            
            btn.onclick = () => {
                const staffObj = staff.find(s => getStaffName(s) === person);
                let phone = getStaffPhone(staffObj);
                
                if (!phone) {
                    phone = prompt(`Enter WhatsApp number for ${person} (e.g., 971501234567):`);
                    if (!phone) return;
                    savePhoneNumber(person, phone);
                }

                // Clean the phone number
                const cleanNumber = cleanPhone(phone);

                const msg = `Transaction Recorded:\nType: ${type.toUpperCase()}\nAmount: ${amount.toFixed(2)} AED\nNote: ${desc}\nDate: ${new Date().toLocaleDateString()}`;
                
                const url = `https://wa.me/${cleanNumber}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
                window.closeModal();
            };
        };

        // --- RENDERERS ---

        function renderRegistry() {
            const listFn = (id, items, type) => {
                const c = document.getElementById(id); if (!c) return;
                c.innerHTML = items.length === 0 ? `<p class="text-[10px] font-bold text-slate-300 uppercase p-2">No Items</p>` :
                    items.map((item, idx) => {
                        const name = type === 'staff' ? getStaffName(item) : item;
                        const phone = type === 'staff' ? getStaffPhone(item) : '';
                        const phoneDisplay = phone ? `<span class="text-[9px] text-slate-400">(${phone})</span>` : '';
                        const escapedName = escapeQuotes(name);
                        return `<div class="bg-white px-3 py-2 rounded-xl border border-slate-100 flex items-center justify-between gap-3 min-w-[100px] hover:shadow-md transition-smooth"><span class="text-[11px] font-bold text-slate-600 uppercase tracking-tight">${name} ${phoneDisplay}</span><button onclick="window.deleteItem('${type}', ${idx})" class="text-slate-300 hover:text-rose-500 transition-colors"><i data-lucide="x" class="w-3 h-3"></i></button></div>`;
                    }).join('');
            };
            listFn('list-staff', staff, 'staff'); listFn('list-source', sources, 'source'); listFn('list-category', categories, 'category');
            
            const filterCat = document.getElementById('filter-cat');
            if(filterCat) {
                const current = filterCat.value;
                filterCat.innerHTML = `<option value="all">All Categories</option>` + categories.map(c => `<option value="${c}">${c}</option>`).join('');
                filterCat.value = current;
            }
            lucide.createIcons();
        }

        function renderPersonSelect() {
            try {
                const wrapper = document.getElementById('person-select-wrapper'); 
                if(!wrapper) return;
                const list = activeTab === 'receive' ? sources : staff.map(s => getStaffName(s));
                if (list.length === 0) { 
                    wrapper.innerHTML = `<button type="button" onclick="window.switchView('settings')" class="w-full px-5 py-4 rounded-xl border-2 border-dashed border-slate-200 text-slate-400 text-[10px] font-bold uppercase hover:border-indigo-300 hover:text-indigo-500 transition-all">Setup Registry</button>`; 
                    return; 
                }
                wrapper.innerHTML = `<select id="form-person" onchange="window.checkAdvanceWallet(this.value)" class="modern-input w-full px-4 py-4 rounded-xl font-bold text-sm text-slate-800 uppercase outline-none focus:border-indigo-600">${list.map(i => `<option value="${i}">${i}</option>`).join('')}</select>`;
                // Safely check wallet for first item if it exists
                if(list[0]) window.checkAdvanceWallet(list[0]);
            } catch(e) {
                console.error("Render Select Error", e);
            }
        }

        window.renderAllocationRows = function() {
            const container = document.getElementById('allocation-rows-container');
            if(!container) return;
            container.innerHTML = currentAllocations.map((alloc, idx) => `
                <div class="flex gap-2 items-center bg-slate-50 p-2 rounded-xl border border-slate-200">
                    <select onchange="window.updateAllocRow(${idx}, 'category', this.value)" class="bg-transparent text-[10px] font-bold uppercase outline-none flex-1 text-slate-700">
                        ${categories.map(c => `<option value="${c}" ${alloc.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                    <input type="text" placeholder="#" value="${alloc.propertyNo || ''}" oninput="window.updateAllocRow(${idx}, 'propertyNo', this.value)" class="w-12 bg-white border border-slate-200 rounded-lg px-2 py-1 text-[10px] font-bold text-center">
                    ${currentAllocations.length > 1 ? `<button type="button" onclick="window.removeAllocationRow(${idx})" class="text-slate-400 hover:text-rose-500 transition-colors px-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>` : ''}
                </div>
            `).join('');
            lucide.createIcons();
        };

        window.renderAdvancesAndDebts = function() {
            try {
                // 1. Staff Advances
                const advList = document.getElementById('advances-list');
                const advSect = document.getElementById('advances-section');
                if(advList && advSect) {
                    const uniqueStaff = [...new Set(staff.map(s => getStaffName(s)))];
                    const activeAdvances = uniqueStaff.map(s => ({ name: s, balance: getAdvanceWalletFor(s) })).filter(x => x.balance > 0.01);
                    advSect.classList.toggle('hidden', activeAdvances.length === 0);
                    advList.innerHTML = activeAdvances.map(a => {
                        const escapedName = escapeQuotes(a.name);
                        return `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex justify-between items-center group hover:bg-white hover:shadow-sm transition-all">
                            <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-wider">${a.name}</p><p class="text-sm font-black text-slate-800">${a.balance.toFixed(2)} <span class="text-[10px] text-slate-400 font-normal">AED</span></p></div>
                            <div class="flex gap-2">
                                <button onclick="window.sendWhatsApp('${escapedName}')" class="px-3 py-1.5 bg-emerald-50 border border-emerald-200 rounded-lg text-[10px] font-bold uppercase text-emerald-600 hover:bg-emerald-100 transition-all flex items-center gap-1"><i data-lucide="message-circle" class="w-3 h-3"></i> WhatsApp</button>
                                <button onclick="window.openSettle('${txs.find(t => t.person === a.name && t.type === 'advance')?.id || ''}')" class="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-[10px] font-bold uppercase text-amber-600 hover:bg-amber-50 hover:border-amber-200 transition-all">Settle</button>
                            </div>
                        </div>
                    `}).join('');
                }

                // 2. Box Debts
                const debtList = document.getElementById('debts-container');
                const debtSect = document.getElementById('pending-debts-section');
                if(debtList && debtSect) {
                    const debts = txs.filter(t => (t.managerOwed || t.staffOwed) && !t.settled).map(t => {
                        const rem = (t.managerOwed || t.staffOwed) - (t.repaidAmount || 0);
                        return { ...t, remaining: rem };
                    }).filter(t => t.remaining > 0.01);
                    debtSect.classList.toggle('hidden', debts.length === 0);
                    debtList.innerHTML = debts.map(d => `
                        <div class="bg-rose-50/50 p-4 rounded-xl border border-rose-100 flex justify-between items-center group hover:bg-rose-50 transition-all">
                            <div><p class="text-[10px] font-black text-rose-400 uppercase tracking-wider">${d.managerOwed ? 'Owed to Me' : 'Owe: ' + d.person}</p><p class="text-sm font-black text-rose-900">${d.remaining.toFixed(2)} AED</p></div>
                            <button onclick="window.openSettle('${d.id}')" class="px-3 py-1.5 bg-white border border-rose-200 rounded-lg text-[10px] font-bold uppercase text-rose-600 hover:bg-rose-600 hover:text-white transition-all">Pay</button>
                        </div>
                    `).join('');
                }
            } catch (e) {
                console.error("Render Advances Error", e);
            }
        };

        window.renderAll = function() {
            try {
                const totals = getTotals();
                const bEl = document.getElementById('stat-balance');
                const aEl = document.getElementById('stat-advances');
                const pEl = document.getElementById('stat-payables');
                
                if(bEl) bEl.innerHTML = `${totals.balance.toFixed(2)} <span class="text-base text-slate-400 font-normal">AED</span>`;
                if(aEl) aEl.innerHTML = `${totals.advances.toFixed(2)} <span class="text-base text-slate-400 font-normal">AED</span>`;
                if(pEl) pEl.innerHTML = `${(totals.owedToMe + totals.owedToStaff).toFixed(2)} <span class="text-base text-slate-400 font-normal">AED</span>`;

                const start = document.getElementById('filter-start').value;
                const end = document.getElementById('filter-end').value;
                const filterCat = document.getElementById('filter-cat').value;
                const filterProp = document.getElementById('filter-prop').value.toLowerCase().trim();
                const filterGeneral = document.getElementById('filter-general').value.toLowerCase().trim();
                
                const sorted = [...txs].sort((a,b) => a.timestamp.localeCompare(b.timestamp));
                let curr = 0; const rbMap = {};
                sorted.forEach(t => {
                    if (t.type === 'receive' || (t.type === 'repayment' && t.isAdvanceReturn)) curr += (parseFloat(t.amount) || 0);
                    else curr -= (parseFloat(t.paidFromBox) || 0);
                    rbMap[t.id] = curr;
                });

                const filtered = txs.filter(t => {
                    const dateMatch = (!start || t.subDate >= start) && (!end || t.subDate <= end);
                    // Safe guard allocations check
                    const hasAllocations = t.allocations && Array.isArray(t.allocations);
                    const catMatch = (filterCat === 'all' || (hasAllocations && t.allocations.some(a => a.category === filterCat)));
                    const propMatch = (!filterProp || (hasAllocations && t.allocations.some(a => (a.propertyNo || '').toLowerCase().includes(filterProp))));
                    
                    const searchMatch = !filterGeneral || 
                        (t.desc && t.desc.toLowerCase().includes(filterGeneral)) ||
                        (t.person && t.person.toLowerCase().includes(filterGeneral)) ||
                        (t.subDate && t.subDate.includes(filterGeneral));

                    return dateMatch && catMatch && propMatch && searchMatch;
                });

                const body = document.getElementById('audit-body');
                if(body) {
                    body.innerHTML = filtered.length ? filtered.map(t => {
                        const rem = (t.managerOwed || t.staffOwed) ? ((t.managerOwed || t.staffOwed) - (t.repaidAmount || 0)) : 0;
                        const debtTag = rem > 0.01 ? `<div class="mt-1 inline-flex items-center gap-1 bg-rose-100 text-rose-700 px-1.5 py-0.5 rounded text-[9px] font-bold uppercase">Pending: ${rem.toFixed(2)}</div>` : '';
                        
                        const allocs = (t.allocations && Array.isArray(t.allocations)) ? t.allocations.map(a => `<span class="bg-slate-100 text-[9px] font-bold px-1.5 py-0.5 rounded text-slate-600 border border-slate-200">${a.category} #${a.propertyNo}</span>`).join(' ') : '';
                        
                        const escapedName = escapeQuotes(t.person || '');
                        
                        return `<tr class="hover:bg-slate-50 transition-colors group">
                            <td class="px-6 py-4 font-bold text-slate-500 font-mono text-xs">${new Date(t.subDate).toLocaleDateString()}</td>
                            <td class="px-6 py-4 font-bold text-slate-700 text-xs">${t.person || '-'}</td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-2">
                                    <span class="text-[9px] font-black uppercase px-2 py-1 rounded-md ${window.getTypeStyles(t.type)}">${t.type}</span>
                                    <span class="font-bold text-slate-700">${t.desc || 'No Desc'}</span>
                                </div>
                                <div class="mt-1.5 flex flex-wrap gap-1">${allocs}</div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-slate-900">${(t.amount || 0).toFixed(2)}</div>
                                ${debtTag}
                            </td>
                            <td class="px-6 py-4 font-bold text-indigo-600 font-mono">${(rbMap[t.id] || 0).toFixed(2)}</td>
                            <td class="text-right px-6 py-4">
                                <div class="flex justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="window.editTx('${t.id}')" class="text-slate-400 hover:text-indigo-600 p-1.5 hover:bg-indigo-50 rounded-lg transition-colors"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="window.deleteTransaction('${t.id}')" class="text-slate-400 hover:text-rose-600 p-1.5 hover:bg-rose-50 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('') : `<tr><td colspan="6" class="py-12 text-center text-slate-400 uppercase font-bold tracking-widest text-xs">No matching records found</td></tr>`;
                }
                
                const lc = document.getElementById('log-count');
                if(lc) lc.innerText = filtered.length;
                
                renderRegistry(); 
                window.renderAdvancesAndDebts(); 
                lucide.createIcons();
            } catch (e) {
                console.error("Render All Error", e);
            }
        };

        // --- GLOBAL INTERACTIVE HELPERS ---

        window.switchView = (v) => {
            ['dashboard', 'history', 'settings'].forEach(id => {
                const el = document.getElementById(`view-${id}`);
                if(el) el.classList.toggle('hidden', id !== v);
                const btn = document.getElementById(`nav-${id}`);
                if (btn) btn.className = id === v ? 'flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all font-bold text-xs shadow-sm bg-white text-indigo-600' : 'flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all text-slate-500 hover:text-slate-700 hover:bg-white/60 font-bold text-xs';
            });
            window.renderAll();
        };

        window.setActiveTab = (tab) => {
            activeTab = tab;
            document.querySelectorAll('#tab-container button').forEach(b => { 
                b.classList.toggle('tab-active', b.dataset.tab === tab); 
                b.classList.toggle('text-slate-400', b.dataset.tab !== tab); 
            });
            const r = document.getElementById('reimburse-fields');
            const a = document.getElementById('allocation-section');
            if(r) r.classList.toggle('hidden', tab !== 'expense');
            if(a) a.classList.toggle('hidden', tab !== 'expense');
            renderPersonSelect();
            if (tab === 'expense') { 
                currentAllocations = [{ id: Date.now(), category: categories[0], propertyNo: '' }]; 
                window.renderAllocationRows(); 
            }
        };

        window.handleInitialSubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const amountInput = document.getElementById('form-amount');
            const descInput = document.getElementById('form-desc');
            const dateInput = document.getElementById('form-sub-date');
            if(!amountInput || !descInput || !dateInput) return;

            const amount = parseFloat(amountInput.value);
            const totals = getTotals();
            const personSelect = document.getElementById('form-person');
            const person = personSelect ? personSelect.value : '';
            const useAdv = document.getElementById('use-advance-wallet')?.checked;
            const reimburseNow = document.getElementById('reimburse-now')?.checked; // Default false
            
            // Capture Invoice Data
            const invNo = document.getElementById('form-inv-no')?.value || '';
            const invDate = document.getElementById('form-inv-date')?.value || '';

            let deductionUsed = 0;
            if (activeTab === 'expense' && useAdv) deductionUsed = Math.min(amount, getAdvanceWalletFor(person));
            
            // Box Amount Needed is the remainder after advance deduction
            const boxAmountNeeded = amount - deductionUsed;
            
            let paidFromBox = 0;
            let staffOwed = 0;
            let settled = false;

            // Logic for "Reimburse Immediately" vs "Pending Debt"
            if (activeTab === 'expense') {
                if (reimburseNow) {
                    // Pay the excess immediately from box
                    paidFromBox = boxAmountNeeded;
                    settled = true; // Fully settled as cash was given
                } else {
                    // Do NOT pay from box, create a Debt
                    paidFromBox = 0;
                    if (boxAmountNeeded > 0) {
                        staffOwed = boxAmountNeeded;
                        settled = false; 
                    } else {
                        settled = true; // Fully covered by advance
                    }
                }
            } else if (activeTab === 'receive') {
                 // Adding funds to box
                 paidFromBox = -amount; // Negative paidFromBox means adding to balance
                 settled = true;
            } else {
                 // Advance giving
                 paidFromBox = amount;
                 settled = true;
            }

            // Deficit Check only if Paying from Box
            if (paidFromBox > 0 && paidFromBox > (totals.balance + 0.01)) {
                 pendingTxData = { type: activeTab, amount, person, desc: descInput.value, invoiceNo: invNo, invoiceDate: invDate, subDate: dateInput.value, timestamp: new Date().toISOString(), paidFromBox: 0, allocations: activeTab === 'expense' ? JSON.parse(JSON.stringify(currentAllocations)) : [], isDeductedFromAdvance: deductionUsed > 0, advanceAmountUsed: deductionUsed, settled: false };
                 document.getElementById('deficit-value').innerText = `${(paidFromBox - totals.balance).toFixed(2)} AED`;
                 document.getElementById('funds-modal').classList.remove('hidden');
                 return;
            }
            
            const data = { 
                type: activeTab, 
                amount, 
                person, 
                desc: descInput.value, 
                invoiceNo: invNo, 
                invoiceDate: invDate, 
                subDate: dateInput.value, 
                timestamp: new Date().toISOString(), 
                paidFromBox: paidFromBox, 
                staffOwed: staffOwed, // New Field
                allocations: activeTab === 'expense' ? JSON.parse(JSON.stringify(currentAllocations)) : [], 
                isDeductedFromAdvance: deductionUsed > 0, 
                advanceAmountUsed: deductionUsed, 
                settled: settled 
            };
            
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), data);
            
            // Trigger Receipt Modal for Advances
            if(activeTab === 'advance') {
                window.openReceiptModal(activeTab, amount, person, descInput.value);
            }

            document.getElementById('entry-form').reset(); 
            document.getElementById('form-sub-date').value = new Date().toISOString().split('T')[0];
            window.showStatus("Recorded.");
            
            // Re-render to hide option
            if(person) window.checkAdvanceWallet(person);
        };

        window.deleteTransaction = async (id) => {
            if(!currentUser || !confirm("Delete transaction?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', id));
            window.showStatus("Deleted.");
        };

        window.confirmSettlement = async () => {
            if (!currentUser) return;
            const val = parseFloat(document.getElementById('settle-amount-input').value) || 0;
            const target = txs.find(t => t.id === settlingId); if (!target) return;
            const targetRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', target.id);
            if (settlementType === 'advance') {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), { type: 'repayment', isAdvanceReturn: true, amount: val, person: target.person, desc: `Cash Return`, subDate: new Date().toISOString().split('T')[0], paidFromBox: -val, timestamp: new Date().toISOString() });
                // Trigger Receipt Modal for Repayments
                window.openReceiptModal('repayment', val, target.person, 'Cash Return');
            } else {
                // Paying off debt
                const newRepaid = (target.repaidAmount || 0) + val;
                await updateDoc(targetRef, { repaidAmount: newRepaid, settled: newRepaid >= ((target.managerOwed || target.staffOwed) - 0.01) });
                // Create a payment record (money leaving box)
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), { type: 'repayment', amount: val, person: target.person, desc: `Pay: ${target.desc}`, subDate: new Date().toISOString().split('T')[0], paidFromBox: val, timestamp: new Date().toISOString() });
            }
            window.showStatus("Settled."); window.closeModal();
        };

        window.addItem = async (type) => { 
            if (!currentUser) return;
            const input = document.getElementById(`new-${type}`); if (!input?.value.trim()) return; 
            const val = input.value.trim();
            
            if (type === 'staff') {
                const phoneInput = document.getElementById('new-staff-phone');
                const phone = phoneInput?.value.trim() || '';
                staff.push({ name: val, phone: phone });
                phoneInput.value = '';
            } else if (type === 'source') {
                sources.push(val); 
            } else {
                categories.push(val);
            }
            
            input.value = ''; 
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'config', 'settings'), { staff, sources, categories });
        };

        window.deleteItem = async (type, index) => { 
            if (!currentUser) return;
            if (type === 'staff') staff.splice(index, 1); else if (type === 'source') sources.splice(index, 1); else categories.splice(index, 1);
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'config', 'settings'), { staff, sources, categories });
        };

        window.editTx = (id) => {
            editingTxId = id; const t = txs.find(x => x.id === id); if (!t) return;
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-type-label').innerText = t.type;
            document.getElementById('edit-amount').value = t.amount;
            document.getElementById('edit-date').value = t.subDate;
            document.getElementById('edit-desc').value = t.desc;
        };

        window.saveEdit = async () => {
            const updateData = { amount: parseFloat(document.getElementById('edit-amount').value), subDate: document.getElementById('edit-date').value, desc: document.getElementById('edit-desc').value };
            await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', editingTxId), updateData);
            window.closeModal(); window.showStatus("Updated.");
        };

        window.processPartial = async (target) => {
            if (!currentUser) return;
            const available = Math.max(0, getTotals().balance);
            const remaining = pendingTxData.amount - (pendingTxData.advanceAmountUsed || 0);
            const gap = remaining - available;
            
            // This is for deficits during IMMEDIATE PAYMENT
            pendingTxData.paidFromBox = available;
            if (target === 'manager') pendingTxData.managerOwed = gap; else pendingTxData.staffOwed = gap;
            
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), pendingTxData);
            window.closeModal(); 
            document.getElementById('entry-form').reset(); 
            document.getElementById('form-sub-date').value = new Date().toISOString().split('T')[0];
        };

        window.updateAllocRow = (idx, key, val) => { currentAllocations[idx][key] = val; if(key === 'category') window.renderAllocationRows(); };
        window.addAllocationRow = () => { currentAllocations.push({ id: Date.now(), category: categories[0], propertyNo: '' }); window.renderAllocationRows(); };
        window.removeAllocationRow = (idx) => { if (currentAllocations.length > 1) { currentAllocations.splice(idx, 1); window.renderAllocationRows(); } };

        window.openSettle = (id) => {
            settlingId = id; const t = txs.find(x => x.id === id); if (!t) return;
            const rem = (t.managerOwed || t.staffOwed) ? ((t.managerOwed || t.staffOwed) - (t.repaidAmount || 0)) : getAdvanceWalletFor(t.person);
            document.getElementById('settle-modal').classList.remove('hidden');
            document.getElementById('settle-subtitle').innerText = `Outstanding: ${rem.toFixed(2)} AED`;
            document.getElementById('settle-amount-input').value = rem.toFixed(2);
            settlementType = (t.type === 'advance') ? 'advance' : 'debt';
        };

        // --- BACKUP & RESTORE ---

        window.exportFullDatabase = async () => {
            const data = { txs, staff, sources, categories };
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], { type: 'application/json' })); a.download = 'pettycash_backup.json'; a.click();
        };

        window.importFullDatabase = async (event) => {
            if (!currentUser) return;
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader(); 
            reader.onload = async (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    window.showStatus("Restoring Data...", false);
                    
                    // 1. Import Settings
                    if (d.staff || d.sources || d.categories) { 
                        staff = d.staff || staff; 
                        sources = d.sources || sources; 
                        categories = d.categories || categories; 
                        await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'config', 'settings'), { staff, sources, categories }); 
                    }

                    // 2. Import Transactions (Restores full history)
                    if (d.txs && Array.isArray(d.txs)) {
                        const txCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions');
                        for (const item of d.txs) {
                            const { id, ...data } = item;
                            await addDoc(txCol, data);
                        }
                    }
                    window.showStatus("Restore Complete", false);
                } catch (err) {
                    window.showStatus("Invalid Backup File", true);
                }
            };
            reader.readAsText(file);
        };

        window.resetData = async () => {
            if (!currentUser || !confirm("WARNING: This will permanently delete all local registry settings. Transaction history in the cloud will remain. Continue?")) return;
            staff = []; sources = []; categories = ["Warehouses", "Open Yard", "Admin Building", "Site General"];
            await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'config', 'settings'), { staff, sources, categories });
        };
        
        window.generateReportExcel = function() {
            // 1. Determine Filtering
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            const filterCat = document.getElementById('filter-cat').value;
            const filterProp = document.getElementById('filter-prop').value.toLowerCase().trim();
            
            // 2. Sort all transactions chronologically (Oldest First)
            const sortedAll = [...txs].sort((a,b) => a.timestamp.localeCompare(b.timestamp));
            
            // 3. Calculate Opening Balance based on start date
            let openingBalance = 0;
            if (start) {
                // Sum (-paidFromBox) for all transactions BEFORE start date
                // paidFromBox > 0 means money out (reduce balance), < 0 means money in (increase balance)
                // So adding (-paidFromBox) correctly adjusts balance
                sortedAll.forEach(t => {
                    if (t.subDate < start) {
                        const flow = -(t.paidFromBox || 0);
                        openingBalance += flow;
                    }
                });
            }
            
            // 4. Filter list for report rows
            const filtered = sortedAll.filter(t => {
                const dateMatch = (!start || t.subDate >= start) && (!end || t.subDate <= end);
                const hasAllocations = t.allocations && Array.isArray(t.allocations);
                const catMatch = (filterCat === 'all' || (hasAllocations && t.allocations.some(a => a.category === filterCat)));
                const propMatch = (!filterProp || (hasAllocations && t.allocations.some(a => (a.propertyNo || '').toLowerCase().includes(filterProp))));
                return dateMatch && catMatch && propMatch;
            });
            
            // 5. Build Report Data
            let currentBalance = openingBalance;
            const data = [];
            
            // Add Opening Balance Row if filtered by date
            if (start) {
                 data.push({
                    "Submission Date": start,
                    "Invoice Date": "-",
                    "Invoice No": "-",
                    "Description": "OPENING BALANCE",
                    "Person": "-",
                    "Total Amount": "-",
                    "Deposit (In)": "-",
                    "Withdrawal (Out)": "-",
                    "Balance": openingBalance.toFixed(2)
                });
            }
            
            filtered.forEach(t => {
                const paidFromBox = t.paidFromBox || 0;
                
                // Logic: paidFromBox negative = IN, positive = OUT
                let cashIn = 0;
                let cashOut = 0;
                
                if (paidFromBox < 0) {
                    cashIn = Math.abs(paidFromBox);
                } else {
                    cashOut = paidFromBox;
                }
                
                // Update running balance
                // Balance += (In - Out)
                // Since cashIn is abs(-paid) and cashOut is paid
                // This is mathematically: Balance += (-paidFromBox)
                currentBalance += (cashIn - cashOut);
                
                data.push({
                    "Submission Date": t.subDate,
                    "Invoice Date": t.invoiceDate || '-',
                    "Invoice No": t.invoiceNo || '-',
                    "Description": t.desc,
                    "Person": t.person || '-',
                    "Total Amount": (t.amount || 0).toFixed(2),
                    "Deposit (In)": cashIn > 0 ? cashIn.toFixed(2) : '-',
                    "Withdrawal (Out)": cashOut > 0 ? cashOut.toFixed(2) : '-',
                    "Balance": currentBalance.toFixed(2)
                });
            });
            
            // 6. Generate Excel File
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Adjust column widths for better readability
            const wscols = [
                {wch: 15}, // Sub Date
                {wch: 15}, // Inv Date
                {wch: 15}, // Inv No
                {wch: 40}, // Description
                {wch: 20}, // Person
                {wch: 15}, // Total
                {wch: 15}, // In
                {wch: 15}, // Out
                {wch: 15}  // Balance
            ];
            ws['!cols'] = wscols;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Petty Cash Report");
            XLSX.writeFile(wb, `PettyCash_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        // --- AUTH & INITIALIZATION ---

        window.handleAuth = async () => {
            const e = document.getElementById('auth-email').value;
            const p = document.getElementById('auth-password').value;
            try {
                if (isSignupMode) await createUserWithEmailAndPassword(auth, e, p);
                else await signInWithEmailAndPassword(auth, e, p);
            } catch (err) { window.showStatus("Authentication Failed", true); }
        };

        window.handleGuestLogin = async () => { 
            try { await signInAnonymously(auth); } catch { window.showStatus("Guest Login Disabled", true); }
        };

        window.toggleAuthMode = () => { isSignupMode = !isSignupMode; document.getElementById('auth-title').innerText = isSignupMode ? "Create New Account" : "Sign In to Dashboard"; };
        
        window.handleLogout = () => signOut(auth).then(() => location.reload());

        window.generateReportPDF = function() {
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            const totals = getTotals();
            document.getElementById('pdf-report-user').innerText = currentUser?.email || 'Guest User';
            document.getElementById('pdf-report-period').innerText = `${start || 'All History'} to ${end || 'Present'}`;
            document.getElementById('pdf-report-balance').innerText = totals.balance.toFixed(2);
            document.getElementById('pdf-generation-time').innerText = new Date().toLocaleString();
            
            const rows = txs.filter(t => (!start || t.subDate >= start) && (!end || t.subDate <= end)).map(t => {
                const isIn = t.type === 'receive' || (t.type === 'repayment' && t.isAdvanceReturn);
                return `<tr><td>${t.subDate}</td><td>${t.person || '-'}</td><td>${t.type.toUpperCase()}</td><td>${t.desc}</td><td style="color:green">${isIn ? t.amount.toFixed(2) : '-'}</td><td style="color:red">${!isIn ? t.amount.toFixed(2) : '-'}</td><td>-</td></tr>`;
            }).join('');
            document.getElementById('report-table-body').innerHTML = rows;
            html2pdf().from(document.getElementById('report-printable-area')).save();
        };

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } 
                    catch { await signInAnonymously(auth).catch(() => {}); }
                } else if (!auth.currentUser) { 
                    await signInAnonymously(auth).catch(() => {}); 
                }
            } catch (err) { console.warn("Auth Auto-Init Skipped"); }
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                
                onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'config', 'settings'), (s) => {
                    if (s.exists()) { 
                        const d = s.data(); 
                        // Handle legacy staff string array vs new object array
                        staff = (d.staff || []).map(item => {
                            return typeof item === 'string' ? { name: item, phone: '' } : item;
                        });
                        sources = d.sources || []; 
                        categories = d.categories || ["Warehouses", "Open Yard", "Admin Building", "Site General"]; 
                        renderRegistry(); 
                        renderPersonSelect(); 
                        // FIX: Ensure category dropdowns in the form update immediately
                        if (typeof window.renderAllocationRows === 'function') window.renderAllocationRows();
                    }
                });
                
                onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), (s) => {
                    txs = s.docs.map(d => ({ id: d.id, ...d.data() })); 
                    txs.sort((a, b) => b.timestamp.localeCompare(a.timestamp)); 
                    window.renderAll(); 
                });

                const today = new Date().toISOString().split('T')[0];
                document.getElementById('form-sub-date').value = today;
                window.setActiveTab('expense');
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        initAuth();
        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>